<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/eclipse.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/sql/sql.min.js"></script>

    <style>
        .CodeMirror {
            border: 1px solid #ced4da;
            border-radius: .375rem;
            font-size: 14px;
            min-height: 160px;
        }
        .table-responsive {
            overflow-x: auto;
        }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">‚öôÔ∏è –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π API</h2>
            <p class="text-muted">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ SQL-–∑–∞–ø—Ä–æ—Å –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</p>
        </div>
        <a href="/" class="btn btn-outline-secondary">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>

    <div class="card shadow-sm p-4">
        <form method="post" action="/create-api" id="apiForm">
            <div class="mb-3">
                <label for="endpoint_name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞</label>
                <input type="text" class="form-control" id="endpoint_name" name="endpoint_name" placeholder="clients" required>
                <div class="form-text">–≠–Ω–¥–ø–æ–∏–Ω—Ç –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: <code>/api/&lt;–Ω–∞–∑–≤–∞–Ω–∏–µ&gt;</code></div>
            </div>

            <div class="mb-3">
                <label for="connector_id" class="form-label">–ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</label>
                <select class="form-select" id="connector_id" name="connector_id" required>
                    {% for connector in connectors %}
                        <option value="{{ connector['id'] }}">{{ connector['name'] }} ({{ connector['db_type'] }})</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="sql_query" class="form-label">SQL-–∑–∞–ø—Ä–æ—Å</label>
                <textarea id="sql_query" name="sql_query" required></textarea>
                <div class="form-text">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: <code>:param</code> –∏–ª–∏ <code>%(param)s</code></div>
            </div>

            <div class="mb-3">
                <label for="parameters" class="form-label">–û–∂–∏–¥–∞–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞</label>
                <input type="text" class="form-control" id="parameters" name="parameters" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ['user_id', 'phone']">
                <div class="form-text">–ß–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</div>
            </div>

            <div class="d-flex gap-3">
                <button type="submit" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å API</button>
                <button type="button" class="btn btn-outline-primary" onclick="testSQL()">üß™ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SQL</button>
            </div>
        </form>

        <div id="testResult" class="mt-4"></div>
    </div>
</div>

<script>
let editor;

document.addEventListener("DOMContentLoaded", function () {
    editor = CodeMirror.fromTextArea(document.getElementById("sql_query"), {
        mode: "text/x-sql",
        theme: "eclipse",
        lineNumbers: true,
        indentWithTabs: true,
        smartIndent: true,
        matchBrackets: true
    });

    document.getElementById("apiForm").addEventListener("submit", function () {
        editor.save(); // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –æ–±—Ä–∞—Ç–Ω–æ –≤ textarea
    });
});

function testSQL() {
    editor.save(); // –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å textarea –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    const connectorId = document.getElementById('connector_id').value;
    const sqlQuery = document.getElementById('sql_query').value;

    if (!sqlQuery.trim()) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.");
        return;
    }

    axios.post('/test-sql', new URLSearchParams({
        connector_id: connectorId,
        sql_query: sqlQuery
    }), {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        const resultDiv = document.getElementById("testResult");
        resultDiv.innerHTML = '';

        const rows = response.data.rows || [];

        if (rows.length === 0) {
            resultDiv.innerHTML = '<div class="alert alert-warning">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>';
            return;
        }

        const table = document.createElement('table');
        table.className = 'table table-bordered table-sm table-striped';

        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        Object.keys(rows[0]).forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        rows.forEach(row => {
            const tr = document.createElement('tr');
            Object.values(row).forEach(value => {
                const td = document.createElement('td');
                td.textContent = value;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        resultDiv.innerHTML = '<h5 class="mb-3">‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:</h5>';
        const wrapper = document.createElement('div');
        wrapper.className = 'table-responsive';
        wrapper.appendChild(table);
        resultDiv.appendChild(wrapper);
    })
    .catch(error => {
        const resultDiv = document.getElementById("testResult");
        const message = error.response?.data?.error || error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
        resultDiv.innerHTML = `<div class="alert alert-danger"><strong>–û—à–∏–±–∫–∞:</strong> ${message}</div>`;
    });
}
</script>

</body>
</html>
