<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/static/favicon.png">

    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/eclipse.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/sql/sql.min.js"></script>

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        .CodeMirror {
            border: 1px solid #ced4da;
            border-radius: .375rem;
            font-size: 14px;
            min-height: 160px;
        }
        .table-responsive {
            overflow-x: auto;
        }
        table {
            table-layout: auto;
            width: max-content;
            min-width: 100%;
        }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å API</h2>
            <p class="text-muted">ID API: <code>{{ api.id }}</code></p>
        </div>
        <a href="/manage-apis" class="btn btn-outline-secondary">‚Üê –ù–∞–∑–∞–¥</a>
    </div>

    <div class="card shadow-sm p-4">
        <form method="post" action="/edit-api/{{ api.id }}" id="editApiForm">
            <div class="mb-3">
                <label for="endpoint_name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞</label>
                <input type="text" class="form-control" id="endpoint_name" name="endpoint_name" value="{{ api['endpoint_name'] }}" required>
                <div class="form-text">–≠–Ω–¥–ø–æ–∏–Ω—Ç –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: <code>/api/{{ api['endpoint_name'] }}</code></div>
            </div>

            <div class="mb-3">
                <label for="connector_id" class="form-label">–ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</label>
                <select class="form-select" id="connector_id" name="connector_id" required>
                    {% for connector in connectors %}
                        <option value="{{ connector['id'] }}" {% if connector['id'] == api['connector_id'] %}selected{% endif %}>
                            {{ connector['name'] }} ({{ connector['db_type'] }})
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="sql_query" class="form-label">SQL-–∑–∞–ø—Ä–æ—Å</label>
                <textarea id="sql_query" name="sql_query" required>{{ api['sql_query'] }}</textarea>
                <div class="form-text">–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: <code>:param</code> –∏–ª–∏ <code>%(param)s</code></div>
            </div>

            <div class="mb-3">
                <label for="parameters" class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã (–≤ JSON-—Ñ–æ—Ä–º–∞—Ç–µ)</label>
                <textarea class="form-control" id="parameters" name="parameters" rows="3" placeholder='["param1", "param2"]'>{{ api['parameters'] }}</textarea>
                <div class="form-text">–ü–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–µ–¥–∞–Ω—ã –≤ API</div>
            </div>

            <div class="d-flex gap-3">
                <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                <button type="button" class="btn btn-outline-primary" onclick="testSQL()">üß™ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SQL</button>
                <a href="/manage-apis" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
            </div>
        </form>

        <div id="testResult" class="mt-4"></div>
    </div>
</div>

<script>
let editor;

document.addEventListener("DOMContentLoaded", function () {
    editor = CodeMirror.fromTextArea(document.getElementById("sql_query"), {
        mode: "text/x-sql",
        theme: "eclipse",
        lineNumbers: true,
        indentWithTabs: true,
        smartIndent: true,
        matchBrackets: true
    });
    editor.focus();

    document.getElementById("editApiForm").addEventListener("submit", function () {
        editor.save();
    });
});

function testSQL() {
    editor.save();

    const connectorId = document.getElementById('connector_id').value;
    const sqlQuery = document.getElementById('sql_query').value;

    if (!sqlQuery.trim()) {
        alert("–í–≤–µ–¥–∏—Ç–µ SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.");
        return;
    }

    axios.post('/test-sql', new URLSearchParams({
        connector_id: connectorId,
        sql_query: sqlQuery
    }), {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        const resultDiv = document.getElementById("testResult");
        resultDiv.innerHTML = '';

        const rows = response.data.rows || [];

        if (rows.length === 0) {
            resultDiv.innerHTML = '<div class="alert alert-warning">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>';
            return;
        }

        const table = document.createElement('table');
        table.className = 'table table-bordered table-sm table-striped';

        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        Object.keys(rows[0]).forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        rows.forEach(row => {
            const tr = document.createElement('tr');
            Object.values(row).forEach(value => {
                const td = document.createElement('td');
                td.textContent = value;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        resultDiv.innerHTML = '<h5 class="mb-3">‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:</h5>';
        const wrapper = document.createElement('div');
        wrapper.className = 'table-responsive';
        wrapper.appendChild(table);
        resultDiv.appendChild(wrapper);
    })
    .catch(error => {
        const resultDiv = document.getElementById("testResult");
        const message = error.response?.data?.error || error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
        resultDiv.innerHTML = `<div class="alert alert-danger"><strong>–û—à–∏–±–∫–∞:</strong> ${message}</div>`;
    });
}
</script>

</body>
</html>
