<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        code {
            word-break: break-word;
        }
        pre {
            max-height: 500px;
            overflow: auto;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
<div class="container py-5">
    <div class="card shadow p-4">
        <h2 class="mb-4">üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API <code>{{ endpoint_name }}</code></h2>

        {% if token %}
        <div class="alert alert-info d-flex justify-content-between align-items-center">
            <div>
                <strong>–í–∞—à —Ç–æ–∫–µ–Ω:</strong><br>
                <code id="authToken">Bearer {{ token }}</code>
            </div>
            <button class="btn btn-sm btn-outline-dark"
                    onclick="navigator.clipboard.writeText('Bearer {{ token }}')">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        {% endif %}

        {% if parameters %}
        <form id="apiForm" class="mb-4">
            <div class="row">
                {% for param in parameters %}
                <div class="col-md-4 mb-3">
                    <label class="form-label">{{ param }}</label>
                    <input type="text" class="form-control" id="{{ param }}" name="{{ param }}" required>
                </div>
                {% endfor %}
            </div>
            <button type="submit" class="btn btn-primary">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
        </form>

        <div class="mb-3">
            <strong>URL:</strong> <a id="finalUrl" target="_blank">{{ base_url }}</a>
        </div>

        <pre class="bg-light p-3 border rounded" id="result">‚Üê –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–í—ã–ø–æ–ª–Ω–∏—Ç—å"</pre>
        {% else %}
        <div class="alert alert-warning">–£ —ç—Ç–æ–≥–æ API –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.</div>
        <a class="btn btn-primary" href="{{ base_url }}">–í—ã–ø–æ–ª–Ω–∏—Ç—å</a>
        {% endif %}

        <a href="/manage-apis" class="btn btn-secondary mt-4">‚Üê –ù–∞–∑–∞–¥</a>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("apiForm");
    if (!form) return;

    form.addEventListener("submit", function (e) {
        e.preventDefault();

        const baseUrl = "{{ base_url }}";
        const params = new URLSearchParams();
        const missing = [];

        {% for param in parameters %}
        const val_{{ param }} = document.getElementById("{{ param }}").value.trim();
        if (!val_{{ param }}) {
            missing.push("{{ param }}");
        } else {
            params.append("{{ param }}", val_{{ param }});
        }
        {% endfor %}

        if (missing.length > 0) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: " + missing.join(", "));
            return;
        }

        const url = baseUrl + "?" + params.toString();
        const headers = {};
        {% if token %}
        headers["Authorization"] = "Bearer {{ token }}";
        {% endif %}

        document.getElementById("finalUrl").textContent = url;
        document.getElementById("finalUrl").href = url;
        document.getElementById("result").textContent = "‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å...";

        fetch(url, { headers })
            .then(async res => {
                const text = await res.text();
                try {
                    const json = JSON.parse(text);
                    document.getElementById("result").textContent = JSON.stringify(json, null, 2);
                } catch {
                    document.getElementById("result").textContent = text || "–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç";
                }

                if (!res.ok) {
                    document.getElementById("result").textContent = `–û—à–∏–±–∫–∞ ${res.status}: ${text}`;
                }
            })
            .catch(err => {
                document.getElementById("result").textContent = "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: " + err;
            });
    });
});
</script>
</body>
</html>
