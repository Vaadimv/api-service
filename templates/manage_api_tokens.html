<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API-—Ç–æ–∫–µ–Ω–∞–º–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="icon" type="image/png" href="/static/favicon.png">
</head>
<body>

<div class="container py-5">    
    {% if request.session.get('message') %}
        <div class="alert alert-info text-center">
         {{ request.session.pop('message') }}
        </div>
    {% endif %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>üîë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API-—Ç–æ–∫–µ–Ω–∞–º–∏</h2>
            <p class="text-muted">–í—ã–¥–∞—á–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ API</p>
        </div>
        <a href="/" class="btn btn-outline-dark btn-sm">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>

    {% if tokens|length > 0 %}
    <!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–∫–µ–Ω–æ–≤ -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">–°–ø–∏—Å–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th>–¢–æ–∫–µ–Ω</th>
                        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                        <th>–°–æ–∑–¥–∞–Ω</th>
                        <th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th>
                        {% if user.role == 'admin' %}
                        <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for t in tokens %}
                    <tr>
                        <td class="text-center">{{ t["id"] }}</td>
                        <td>{{ t["username"] }}</td>
                        <td><code>{{ t["token"] }}</code></td>
                        <td>{{ t["comment"] or "‚Äî" }}</td>
                        <td>{{ t["created_at"] }}</td>
                        <td>{{ t["expires_at"] or "‚Äî" }}</td>
                        {% if user.role == 'admin' %}
                        <td class="text-center">
                            <a href="/delete-token/{{ t['id'] }}" class="btn btn-sm btn-danger"
                               onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–∫–µ–Ω?')">
                               <i class="fa fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                            </a>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if user.role == 'admin' %}
    <!-- –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: —Ñ–æ—Ä–º–∞ –≤—ã–¥–∞—á–∏ —Ç–æ–∫–µ–Ω–∞ -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">–í—ã–¥–∞—Ç—å –Ω–æ–≤—ã–π API-—Ç–æ–∫–µ–Ω</h5>
        </div>
        <div class="card-body">
            <form method="post" action="/issue-token" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                    <select name="user_id" class="form-select" required>
                        {% for u in users %}
                            <option value="{{ u['id'] }}">{{ u['username'] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <input type="text" name="comment" class="form-control" placeholder="Postman, CI/CD –∏ —Ç.–¥.">
                </div>
                <div class="col-md-3">
                    <label class="form-label">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–æ–ø—Ü.)</label>
                    <input type="date" name="expires_at" class="form-control">
                </div>
                <div class="col-md-2 align-self-end">
                    <button type="submit" class="btn btn-success w-100">–í—ã–¥–∞—Ç—å —Ç–æ–∫–µ–Ω</button>
                </div>
            </form>
        </div>
    </div>
    {% else %}
        {% if tokens|length == 0 %}
        <!-- –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ -->
        <div class="alert alert-info text-center">
            –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤.
            <form method="post" action="/request-token" class="d-inline">
                <input type="hidden" name="comment" value="">
                <button type="submit" class="btn btn-sm btn-outline-primary ms-2">–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
            </form>
        </div>
        {% endif %}
    {% endif %}
<!-- Zayavki na tokeni-->
    {% if user['role'] == 'admin' and requests %}
    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <h5 class="mb-0">–ó–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–¥–∞—á—É —Ç–æ–∫–µ–Ω–æ–≤</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
                <thead class="table-warning">
                    <tr>
                        <th>ID</th>
                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                        <th>–ó–∞–ø—Ä–æ—à–µ–Ω–æ</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in requests %}
                    <tr>
                        <td>{{ r["id"] }}</td>
                        <td>{{ r["username"] }}</td>
                        <td>{{ r["comment"] or "‚Äî" }}</td>
                        <td>{{ r["requested_at"][:19].replace('T', ' ') }}</td>
                        <td>
                            {% if r["status"] == 'pending' %}
                                <span class="badge bg-warning text-dark">–í –æ–∂–∏–¥–∞–Ω–∏–∏</span>
                            {% elif r["status"] == 'approved' %}
                                <span class="badge bg-success">–û–¥–æ–±—Ä–µ–Ω–æ</span>
                            {% else %}
                                <span class="badge bg-secondary">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    {% if user['role'] != 'admin' and requests %}
    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <h5 class="mb-0">–ú–æ–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ —Ç–æ–∫–µ–Ω—ã</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                        <th>–î–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in requests %}
                    <tr>
                        <td>{{ r["id"] }}</td>
                        <td>{{ r["comment"] or "‚Äî" }}</td>
                        <td>{{ r["requested_at"][:19].replace('T', ' ') }}</td>
                        <td>
                            {% if r["status"] == 'pending' %}
                                <span class="badge bg-warning text-dark">–í –æ–∂–∏–¥–∞–Ω–∏–∏</span>
                            {% elif r["status"] == 'approved' %}
                                <span class="badge bg-success">–û–¥–æ–±—Ä–µ–Ω–æ</span>
                            {% else %}
                                <span class="badge bg-secondary">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
         
    <div class="mt-4">
        <a href="/" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>
</div>

</body>
</html>
